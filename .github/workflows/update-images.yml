name: Auto-Update Docker Images in Helm Values

on:
  repository_dispatch:
    types: [images-built]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'New image tag (e.g., ci-abc123def456)'
        required: true
        type: string
      guacamole_tag:
        description: 'Guacamole image tag override (optional)'
        required: false
        type: string
      guacd_tag:
        description: 'Guacd image tag override (optional)'
        required: false
        type: string
      mariadb_tag:
        description: 'MariaDB image tag override (optional)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  update-values:
    name: Update Helm values.yaml with new image tags
    runs-on: ubuntu-latest
    steps:
      - name: Checkout helm repository
        uses: actions/checkout@v4
        with:
          repository: kyos-hell/helm-apache-guacamole
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get image tag from event
        id: event_tag
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            TAG="${{ github.event.client_payload.image_tag }}"
            GUACAMOLE_TAG="${{ github.event.client_payload.guacamole_tag }}"
            GUACD_TAG="${{ github.event.client_payload.guacd_tag }}"
            MARIADB_TAG="${{ github.event.client_payload.mariadb_tag }}"
          else
            TAG="${{ github.event.inputs.image_tag }}"
            GUACAMOLE_TAG="${{ github.event.inputs.guacamole_tag }}"
            GUACD_TAG="${{ github.event.inputs.guacd_tag }}"
            MARIADB_TAG="${{ github.event.inputs.mariadb_tag }}"
          fi
          
          # Si pas d'override, utiliser le tag par d√©faut
          GUACAMOLE_TAG=${GUACAMOLE_TAG:-$TAG}
          GUACD_TAG=${GUACD_TAG:-$TAG}
          MARIADB_TAG=${MARIADB_TAG:-$TAG}
          
          echo "guacamole_tag=${GUACAMOLE_TAG}" >> $GITHUB_OUTPUT
          echo "guacd_tag=${GUACD_TAG}" >> $GITHUB_OUTPUT
          echo "mariadb_tag=${MARIADB_TAG}" >> $GITHUB_OUTPUT
          
          echo "üìã Image tags to update:"
          echo "  guacamole: ${GUACAMOLE_TAG}"
          echo "  guacd: ${GUACD_TAG}"
          echo "  mariadb-guacamole: ${MARIADB_TAG}"

      - name: Update values.yaml
        id: update
        env:
          GUACAMOLE_TAG: ${{ steps.event_tag.outputs.guacamole_tag }}
          GUACD_TAG: ${{ steps.event_tag.outputs.guacd_tag }}
          MARIADB_TAG: ${{ steps.event_tag.outputs.mariadb_tag }}
        run: |
          # Backup original
          cp values.yaml values.yaml.backup
          
          echo "üîç Step 1: Check environment variables"
          echo "GUACAMOLE_TAG=$GUACAMOLE_TAG"
          echo "GUACD_TAG=$GUACD_TAG"
          echo "MARIADB_TAG=$MARIADB_TAG"
          
          echo ""
          echo "üîç Step 2: Check original values.yaml (guacamole section)"
          grep -A 5 "guacamole:" values.yaml | head -20
          
          # Update image tags using Python
          python3 << "PYTHON_EOF"
          import re
          import os
          
          print("üîç Step 3: Python script started")
          
          with open('values.yaml', 'r') as f:
              content = f.read()
          
          guacamole_tag = os.environ['GUACAMOLE_TAG']
          guacd_tag = os.environ['GUACD_TAG']
          mariadb_tag = os.environ['MARIADB_TAG']
          
          print(f"Variables re√ßues:")
          print(f"  GUACAMOLE_TAG={guacamole_tag}")
          print(f"  GUACD_TAG={guacd_tag}")
          print(f"  MARIADB_TAG={mariadb_tag}")
          
          original_content = content
          
          # Update guacamole image tag
          print("\nüîç Step 4a: Replacing guacamole tag...")
          content = re.sub(
              r'(guacamole:\s+.*?image:.*?tag:\s*)latest',
              r'\1' + guacamole_tag,
              content,
              flags=re.DOTALL,
              count=1
          )
          if content != original_content:
              print("‚úì guacamole tag replaced")
              original_content = content
          else:
              print("‚úó guacamole tag NOT replaced - regex may not match")
          
          # Update guacd image tag
          print("üîç Step 4b: Replacing guacd tag...")
          content_before = content
          content = re.sub(
              r'(guacd:\s+.*?image:.*?tag:\s*)latest',
              r'\1' + guacd_tag,
              content,
              flags=re.DOTALL,
              count=1
          )
          if content != content_before:
              print("‚úì guacd tag replaced")
          else:
              print("‚úó guacd tag NOT replaced - regex may not match")
          
          # Update mariadb image tag
          print("üîç Step 4c: Replacing mariadb tag...")
          content_before = content
          content = re.sub(
              r'(mariadb:\s+.*?image:.*?tag:\s*)latest',
              r'\1' + mariadb_tag,
              content,
              flags=re.DOTALL,
              count=1
          )
          if content != content_before:
              print("‚úì mariadb tag replaced")
          else:
              print("‚úó mariadb tag NOT replaced - regex may not match")
          
          with open('values.yaml', 'w') as f:
              f.write(content)
          
          print("\nüîç Step 5: Python script completed")
          PYTHON_EOF
          
          echo ""
          echo "üîç Step 6: Check updated values.yaml (guacamole section)"
          grep -A 5 "guacamole:" values.yaml | head -20
          
          # Check if anything changed
          echo ""
          echo "üîç Step 7: Comparing files"
          if diff -q values.yaml.backup values.yaml > /dev/null 2>&1; then
            echo "files_changed=false" >> $GITHUB_OUTPUT
            echo "‚úó No changes detected"
          else
            echo "files_changed=true" >> $GITHUB_OUTPUT
            echo "‚úì Changes detected!"
            echo ""
            echo "=== Diff ==="
            diff -u values.yaml.backup values.yaml || true
          fi
          
          rm -f values.yaml.backup

      - name: Configure Git
        if: steps.update.outputs.files_changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Commit and push
        if: steps.update.outputs.files_changed == 'true'
        run: |
          git add values.yaml
          git commit -m "chore: auto-update docker image tags
          
          Updated tags:
          - guacamole: ${{ steps.event_tag.outputs.guacamole_tag }}
          - guacd: ${{ steps.event_tag.outputs.guacd_tag }}
          - mariadb-guacamole: ${{ steps.event_tag.outputs.mariadb_tag }}
          
          Triggered by: ${{ github.event_name }}"
          
          git push origin HEAD:main

      - name: Summary
        run: |
          echo "## üöÄ Helm Values Updated"
          echo ""
          echo "### Updated Tags:"
          echo "- **guacamole**: ${{ steps.event_tag.outputs.guacamole_tag }}"
          echo "- **guacd**: ${{ steps.event_tag.outputs.guacd_tag }}"
          echo "- **mariadb-guacamole**: ${{ steps.event_tag.outputs.mariadb_tag }}"
          echo ""
          if [ "${{ steps.update.outputs.files_changed }}" = "true" ]; then
            echo "‚úÖ Values updated and pushed successfully"
          else
            echo "‚ö†Ô∏è No changes were made - values may already be up-to-date or regex pattern may not match"
          fi
          echo "ArgoCD will automatically detect and deploy the changes."