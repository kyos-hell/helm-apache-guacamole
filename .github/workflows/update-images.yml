name: Auto-Update Docker Images in Helm Values

on:
  repository_dispatch:
    types: [images-built]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'New image tag (e.g., ci-abc123def456)'
        required: true
        type: string
      guacamole_tag:
        description: 'Guacamole image tag override (optional)'
        required: false
        type: string
      guacd_tag:
        description: 'Guacd image tag override (optional)'
        required: false
        type: string
      mariadb_tag:
        description: 'MariaDB image tag override (optional)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  update-values:
    name: Update Helm values.yaml with new image tags
    runs-on: ubuntu-latest
    steps:
      - name: Checkout helm repository
        uses: actions/checkout@v4
        with:
          repository: kyos-hell/helm-apache-guacamole
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get image tag from event
        id: event_tag
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            TAG="${{ github.event.client_payload.image_tag }}"
            GUACAMOLE_TAG="${{ github.event.client_payload.guacamole_tag }}"
            GUACD_TAG="${{ github.event.client_payload.guacd_tag }}"
            MARIADB_TAG="${{ github.event.client_payload.mariadb_tag }}"
          else
            TAG="${{ github.event.inputs.image_tag }}"
            GUACAMOLE_TAG="${{ github.event.inputs.guacamole_tag }}"
            GUACD_TAG="${{ github.event.inputs.guacd_tag }}"
            MARIADB_TAG="${{ github.event.inputs.mariadb_tag }}"
          fi
          
          # Si pas d'override, utiliser le tag par dÃ©faut
          GUACAMOLE_TAG=${GUACAMOLE_TAG:-$TAG}
          GUACD_TAG=${GUACD_TAG:-$TAG}
          MARIADB_TAG=${MARIADB_TAG:-$TAG}
          
          echo "guacamole_tag=${GUACAMOLE_TAG}" >> $GITHUB_OUTPUT
          echo "guacd_tag=${GUACD_TAG}" >> $GITHUB_OUTPUT
          echo "mariadb_tag=${MARIADB_TAG}" >> $GITHUB_OUTPUT
          
          echo "í³‹ Image tags to update:"
          echo "  guacamole: ${GUACAMOLE_TAG}"
          echo "  guacd: ${GUACD_TAG}"
          echo "  mariadb-guacamole: ${MARIADB_TAG}"

      - name: Update values.yaml
        id: update
        env:
          GUACAMOLE_TAG: ${{ steps.event_tag.outputs.guacamole_tag }}
          GUACD_TAG: ${{ steps.event_tag.outputs.guacd_tag }}
          MARIADB_TAG: ${{ steps.event_tag.outputs.mariadb_tag }}
        run: |
          # Backup original
          cp values.yaml values.yaml.backup
          
          # Update image tags using Python
          python3 << 'PYTHON_EOF'
          import re
          
          with open('values.yaml', 'r') as f:
              content = f.read()
          
          # Update guacamole image tag
          content = re.sub(
              r'(guacamole:\s+.*?image:.*?tag:\s*)latest',
              r'\1'"$GUACAMOLE_TAG",
              content,
              flags=re.DOTALL,
              count=1
          )
          
          # Update guacd image tag
          content = re.sub(
              r'(guacd:\s+.*?image:.*?tag:\s*)latest',
              r'\1'"$GUACD_TAG",
              content,
              flags=re.DOTALL,
              count=1
          )
          
          # Update mariadb image tag
          content = re.sub(
              r'(mariadb:\s+.*?image:.*?tag:\s*)latest',
              r'\1'"$MARIADB_TAG",
              content,
              flags=re.DOTALL,
              count=1
          )
          
          with open('values.yaml', 'w') as f:
              f.write(content)
          PYTHON_EOF
          
          # Check if anything changed
          if diff -q values.yaml.backup values.yaml > /dev/null 2>&1; then
            echo "files_changed=false" >> $GITHUB_OUTPUT
            echo "âœ“ No changes detected"
          else
            echo "files_changed=true" >> $GITHUB_OUTPUT
            echo "âœ“ Updated values.yaml"
            echo ""
            echo "=== Changes ==="
            diff -u values.yaml.backup values.yaml || true
          fi
          
          rm -f values.yaml.backup

      - name: Configure Git
        if: steps.update.outputs.files_changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Commit and push
        if: steps.update.outputs.files_changed == 'true'
        run: |
          git add values.yaml
          git commit -m "chore: auto-update docker image tags
          
          Updated tags:
          - guacamole: ${{ steps.event_tag.outputs.guacamole_tag }}
          - guacd: ${{ steps.event_tag.outputs.guacd_tag }}
          - mariadb-guacamole: ${{ steps.event_tag.outputs.mariadb_tag }}
          
          Triggered by: ${{ github.event_name }}"
          
          git push origin HEAD:main

      - name: Summary
        run: |
          echo "## íº€ Helm Values Updated"
          echo ""
          echo "### Updated Tags:"
          echo "- **guacamole**: ${{ steps.event_tag.outputs.guacamole_tag }}"
          echo "- **guacd**: ${{ steps.event_tag.outputs.guacd_tag }}"
          echo "- **mariadb-guacamole**: ${{ steps.event_tag.outputs.mariadb_tag }}"
          echo ""
          echo "ArgoCD will automatically detect and deploy the changes."
